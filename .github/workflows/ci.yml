name: CI - VideoSum Mobile App Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ===============================================
  # 1. CORE VALIDATION & LINTING (Biome/Ruff Equivalent)
  # ===============================================
  validation:
    name: Validate & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js (For Expo/React Native)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run TypeScript Type Check (Strict Mode)
        run: npm run typecheck

      - name: Run ESLint/Biome Linting
        # Assuming 'lint' script runs Biome/ESLint as per Apex standards for JS/TS
        run: npm run lint

      - name: Run Prettier Formatting Check
        # Assuming 'format:check' runs Prettier to ensure zero formatting deviations
        run: npm run format:check

      # NOTE: Unit tests (Vitest equivalent) would be run here if configured
      # - name: Run Unit Tests
      #   run: npm run test:unit

  # ===============================================
  # 2. SECURITY SCAN (SAST/Dependency Analysis)
  # ===============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies (For security scan)
        run: npm ci

      - name: Run Snyk Dependency Scan (Simulated)
        # In a real Apex setup, this would be a configured SAST/SCA tool like Snyk or Mend
        run: echo "Simulating Snyk scan against dependencies..."
        # uses: snyk/actions/npm@master
        # with:
        #   command: 'test'

  # ===============================================
  # 3. BUILD AND ARTIFACT GENERATION (For Review)
  # ===============================================
  build_check:
    name: Build APK/IPA Preview
    runs-on: macos-latest # Required for iOS builds, but good for general Expo test
    needs: [validation]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Expo Preview Artifact (Android)
        # This step verifies the bundling process completes successfully
        run: npx expo build:android --profile preview

      - name: Build Expo Preview Artifact (iOS)
        # This step verifies the bundling process completes successfully
        run: npx expo build:ios --profile preview

# ===============================================
# INTEGRATION SUMMARY
# ===============================================
# If all jobs pass, the PR or push is considered high-fidelity.
# Failure in 'validation' job blocks merges immediately.
